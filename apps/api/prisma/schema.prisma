generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String        @id @default(uuid())
  name        String
  slug        String        @unique
  plan        String        @default("free")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  users       User[]
  monitors    Monitor[]
  incidents   Incident[]
  apiKeys     ApiKey[]
  auditLogs   AuditLog[]
  channels    AlertChannel[]
  alertRules  AlertRule[]

  @@map("organizations")
}

model User {
  id                    String       @id @default(uuid())
  email                 String       @unique
  passwordHash          String
  passwordResetToken    String?
  passwordResetExpiry   DateTime?
  role                  String       @default("viewer") // owner, admin, editor, viewer
  organization          Organization @relation(fields: [organizationId], references: [id])
  organizationId        String
  twoFactorEnabled      Boolean      @default(false)
  twoFactorSecret       String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@map("users")
}

model ApiKey {
  id             String       @id @default(uuid())
  name           String
  key            String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  lastUsedAt     DateTime?
  createdAt      DateTime     @default(now())

  @@map("api_keys")
}

model Monitor {
  id             String         @id @default(uuid())
  name           String
  type           String         // http, tcp, icmp, dns, ssl
  target         String
  interval       Int            @default(60) // in seconds
  status         String         @default("pending") // up, down, degraded, pending, paused
  lastCheckAt    DateTime?
  organization   Organization   @relation(fields: [organizationId], references: [id])
  organizationId String
  metadata       Json?          // custom headers, body match, etc.
  checks         MonitorCheck[]
  incidents      Incident[]
  alertRules     AlertRule[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("monitors")
}

model MonitorCheck {
  id         String   @id @default(uuid())
  monitor    Monitor  @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  monitorId  String
  status     String
  latency    Int      // in ms
  message    String?
  statusCode Int?
  region     String?  // worker region (e.g. us-east-1)
  createdAt  DateTime @default(now())

  @@index([monitorId, createdAt])
  @@map("monitor_checks")
}

model Incident {
  id             String       @id @default(uuid())
  monitor        Monitor      @relation(fields: [monitorId], references: [id])
  monitorId      String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  status         String       @default("open") // open, resolved
  severity       String       @default("error") // critical, error, warning
  startedAt      DateTime     @default(now())
  resolvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("incidents")
}

model AlertChannel {
  id             String        @id @default(uuid())
  name           String
  type           String        // email, slack, discord, telegram, webhook
  config         Json          // encrypted or structured config
  isActive       Boolean       @default(true)
  organization   Organization  @relation(fields: [organizationId], references: [id])
  organizationId String
  alertRules     AlertRule[]
  createdAt      DateTime      @default(now())

  @@map("alert_channels")
}

model AlertRule {
  id             String        @id @default(uuid())
  name           String
  monitor        Monitor       @relation(fields: [monitorId], references: [id], onDelete: Cascade)
  monitorId      String
  alertChannel   AlertChannel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelId      String
  triggerOn      String        @default("down") // down, degraded, up (on recovery)
  enabled        Boolean       @default(true)
  organization   Organization  @relation(fields: [organizationId], references: [id])
  organizationId String
  alertLogs      AlertLog[]
  createdAt      DateTime      @default(now())

  @@unique([monitorId, channelId])
  @@map("alert_rules")
}

model AlertLog {
  id          String     @id @default(uuid())
  alertRule   AlertRule  @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  ruleId      String
  status      String     @default("pending") // pending, sent, failed
  sentAt      DateTime?
  error       String?
  createdAt   DateTime   @default(now())

  @@map("alert_logs")
}

model AuditLog {
  id             String       @id @default(uuid())
  action         String
  resource       String
  resourceId     String?
  actorId        String?      // User ID
  payload        Json?
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  createdAt      DateTime     @default(now())

  @@map("audit_logs")
}
